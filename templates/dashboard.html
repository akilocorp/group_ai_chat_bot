<!DOCTYPE html>
<html lang="en">
<head>
<title>Chat Monitoring Dashboard v2.0</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- JSZipÂ∫ìÁî®‰∫éÂàõÂª∫ZIPÊñá‰ª∂ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
body{
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  padding: 20px;
  margin: 0;
}

.container{
  max-width: 1400px;
  margin: auto;
  background: rgba(0,0,0,0.2);
  border-radius: 15px;
  padding: 30px;
  backdrop-filter: blur(10px);
}

h1{
  text-align: center;
  margin-bottom: 30px;
  font-size: 32px;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

h2{
  font-size: 18px;
  margin-top: 30px;
  margin-bottom: 15px;
  color: rgba(255,255,255,0.9);
}

.stats-grid{
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card{
  background: rgba(255,255,255,0.1);
  padding: 20px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.2);
  text-align: center;
  transition: transform 0.3s;
}

.stat-card:hover{
  transform: translateY(-5px);
  background: rgba(255,255,255,0.15);
}

.stat-card h3{
  margin: 0;
  font-size: 14px;
  opacity: 0.8;
}

.stat-card .number{
  font-size: 36px;
  font-weight: bold;
  margin: 10px 0 0 0;
}

.stat-card .subtext{
  font-size: 12px;
  opacity: 0.7;
  margin-top: 5px;
}

/* Tabs for different views */
.tabs{
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.tab-btn{
  padding: 12px 24px;
  background: rgba(255,255,255,0.1);
  border: none;
  border-radius: 8px;
  color: white;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s;
}

.tab-btn.active{
  background: rgba(255,255,255,0.3);
  box-shadow: 0 0 15px rgba(255,255,255,0.2);
}

.tab-btn:hover{
  background: rgba(255,255,255,0.2);
}

.tab-content{
  display: none;
}

.tab-content.active{
  display: block;
}

/* Rooms Table */
.rooms-table{
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
  background: rgba(255,255,255,0.05);
  border-radius: 10px;
  overflow: hidden;
}

.rooms-table thead{
  background: rgba(255,255,255,0.1);
}

.rooms-table th{
  padding: 15px;
  text-align: left;
  font-weight: 600;
  border-bottom: 2px solid rgba(255,255,255,0.2);
}

.rooms-table td{
  padding: 12px 15px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  vertical-align: top;
}

.rooms-table tr:hover{
  background: rgba(255,255,255,0.08);
}

/* Chat History Panel */
.chat-history-panel{
  display: flex;
  gap: 20px;
  margin-top: 20px;
}

.chat-rooms-sidebar{
  flex: 1;
  background: rgba(255,255,255,0.05);
  border-radius: 10px;
  padding: 20px;
  max-width: 300px;
}

.chat-messages{
  flex: 2;
  background: rgba(255,255,255,0.05);
  border-radius: 10px;
  padding: 20px;
  display: flex;
  flex-direction: column;
}

.room-list{
  max-height: 400px;
  overflow-y: auto;
}

.room-item{
  padding: 12px;
  margin: 8px 0;
  background: rgba(255,255,255,0.08);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
}

.room-item:hover{
  background: rgba(255,255,255,0.15);
}

.room-item.active{
  background: rgba(255,255,255,0.25);
  border-left: 4px solid #667eea;
}

.room-info{
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.message-container{
  flex: 1;
  overflow-y: auto;
  background: rgba(0,0,0,0.2);
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
  min-height: 300px;
}

.message{
  margin: 10px 0;
  padding: 12px;
  background: rgba(255,255,255,0.1);
  border-radius: 8px;
  border-left: 4px solid;
}

.message.user{
  border-left-color: #4CAF50;
}

.message.bot{
  border-left-color: #9C27B0;
}

.message.system{
  border-left-color: #FF9800;
}

.message-header{
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  opacity: 0.8;
  margin-bottom: 5px;
}

.message-sender{
  font-weight: bold;
}

.message-time{
  font-family: monospace;
}

.message-content{
  word-wrap: break-word;
  line-height: 1.4;
}

.message-input{
  display: flex;
  gap: 10px;
}

.message-input input{
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 8px;
  background: rgba(255,255,255,0.1);
  color: white;
}

.message-input input::placeholder{
  color: rgba(255,255,255,0.5);
}

.message-input button{
  padding: 12px 24px;
  background: #4CAF50;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
}

.message-input button:hover{
  background: #45a049;
}

/* Buttons */
.btn{
  padding: 10px 20px;
  margin: 5px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s;
  font-weight: 600;
}

.btn-primary{
  background: #4CAF50;
  color: white;
}

.btn-primary:hover{
  background: #45a049;
  transform: translateY(-2px);
}

.btn-info{
  background: #2196F3;
  color: white;
}

.btn-info:hover{
  background: #0b7dda;
  transform: translateY(-2px);
}

.btn-danger{
  background: #f44336;
  color: white;
}

.btn-danger:hover{
  background: #da190b;
  transform: translateY(-2px);
}

.btn-success{
  background: #28a745;
  color: white;
}

.btn-success:hover{
  background: #218838;
  transform: translateY(-2px);
}

.btn-warning{
  background: #ffc107;
  color: #212529;
}

.btn-warning:hover{
  background: #e0a800;
  transform: translateY(-2px);
}

.btn-sm{
  padding: 8px 12px;
  font-size: 12px;
  margin: 2px;
}

/* Status badges */
.status-badge{
  display: inline-block;
  padding: 5px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: bold;
}

.status-active{
  background: #4CAF50;
  color: white;
}

.status-inactive{
  background: #999;
  color: white;
}

/* Export buttons */
.export-buttons{
  display: flex;
  gap: 10px;
  margin-top: 10px;
  flex-wrap: wrap;
}

/* Logs */
.logs{
  background: #000;
  color: #0f0;
  padding: 15px;
  border-radius: 10px;
  height: 200px;
  overflow-y: auto;
  font-family: 'Courier New', monospace;
  font-size: 12px;
  margin-top: 20px;
}

.controls{
  margin-bottom: 15px;
}

/* Empty state */
.empty-state{
  text-align: center;
  padding: 40px;
  opacity: 0.7;
}

/* Search box */
.search-box{
  margin-bottom: 15px;
}

.search-box input{
  width: 100%;
  padding: 12px;
  border: none;
  border-radius: 8px;
  background: rgba(255,255,255,0.1);
  color: white;
}

.search-box input::placeholder{
  color: rgba(255,255,255,0.5);
}

@media (max-width: 768px){
  .stats-grid{
    grid-template-columns: 1fr;
  }

  .rooms-table{
    font-size: 12px;
  }

  .rooms-table th, .rooms-table td{
    padding: 8px;
  }

  .btn-sm{
    display: block;
    width: 100%;
    margin: 5px 0;
  }

  .chat-history-panel{
    flex-direction: column;
  }

  .chat-rooms-sidebar{
    max-width: 100%;
  }
}
</style>
</head>
<body>

<div class="container">
  <h1>üìä Chat Monitoring Dashboard</h1>

  <!-- Statistics Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <h3>üìä Total Rooms</h3>
      <div class="number" id="total-rooms">0</div>
      <div class="subtext">Active conversations</div>
    </div>
    <div class="stat-card">
      <h3>üë• Total Users</h3>
      <div class="number" id="total-users">0</div>
      <div class="subtext">Active participants</div>
    </div>
    <div class="stat-card">
      <h3>üí¨ Total Messages</h3>
      <div class="number" id="total-messages">0</div>
      <div class="subtext">All-time messages</div>
    </div>
    <div class="stat-card">
      <h3>ü§ñ Bot Status</h3>
      <div class="number" id="bot-status">‚ùå</div>
      <div class="subtext" id="bot-status-text">Disabled</div>
    </div>
  </div>

  <!-- Tabs for different views -->
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('rooms')">üè† Active Rooms</button>
    <button class="tab-btn" onclick="switchTab('chat')">üí¨ Chat Monitor</button>
    <button class="tab-btn" onclick="switchTab('stats')">üìà Statistics</button>
    <button class="tab-btn" onclick="switchTab('config')">‚öôÔ∏è Configuration</button>
  </div>

  <!-- Active Rooms Tab -->
  <div id="rooms-tab" class="tab-content active">
    <h2>üìã Active Chat Rooms</h2>
    <div class="controls">
      <button class="btn btn-primary" onclick="refreshRooms()">üîÑ Refresh Rooms</button>
      <button class="btn btn-info" onclick="exportRoomsCSV()">üì• Export Rooms CSV</button>
      <button class="btn btn-warning" onclick="exportAllChatHistories()">üì¶ Export All Chat Histories</button>
      <button class="btn btn-danger" onclick="cleanupInactiveRooms()">üßπ Cleanup Inactive</button>
    </div>

    <div class="search-box">
      <input type="text" id="room-search" placeholder="üîç Search rooms..." oninput="filterRooms()">
    </div>

    <table class="rooms-table" id="rooms-table">
      <thead>
        <tr>
          <th>Room ID</th>
          <th>Participants</th>
          <th>Messages</th>
          <th>Created</th>
          <th>Bot</th>
          <th>Connections</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="rooms-body">
        <tr><td colspan="7" class="empty-state">Loading rooms...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Chat Monitor Tab -->
  <div id="chat-tab" class="tab-content">
    <h2>üí¨ Live Chat Monitor</h2>
    <div class="controls">
      <button class="btn btn-primary" onclick="startChatMonitor()">‚ñ∂Ô∏è Start Monitoring</button>
      <button class="btn btn-danger" onclick="stopChatMonitor()">‚èπÔ∏è Stop Monitoring</button>
      <button class="btn btn-info" onclick="clearChatDisplay()">üóëÔ∏è Clear Display</button>
      <div class="export-buttons">
        <button class="btn btn-success" onclick="exportChatHistory('csv')" id="export-csv-btn" disabled>üì• Export CSV</button>
        <button class="btn btn-info" onclick="exportChatHistory('json')" id="export-json-btn" disabled>üì• Export JSON</button>
      </div>
    </div>

    <div class="chat-history-panel">
      <div class="chat-rooms-sidebar">
        <h3>üìÅ Active Rooms</h3>
        <div class="room-list" id="monitor-room-list">
          <div class="empty-state">Select a room to monitor</div>
        </div>
      </div>

      <div class="chat-messages">
        <h3 id="selected-room-title">üí¨ Chat Messages</h3>
        <div class="message-container" id="chat-messages-container">
          <div class="empty-state">Select a room to view messages</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Statistics Tab -->
  <div id="stats-tab" class="tab-content">
    <h2>üìà Detailed Statistics</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <h3>üìÖ Today's Messages</h3>
        <div class="number" id="today-messages">0</div>
        <div class="subtext">Messages sent today</div>
      </div>
      <div class="stat-card">
        <h3>‚ö° Active Now</h3>
        <div class="number" id="active-now">0</div>
        <div class="subtext">Active in last 5 min</div>
      </div>
      <div class="stat-card">
        <h3>‚è±Ô∏è Avg Session</h3>
        <div class="number" id="avg-session">0m</div>
        <div class="subtext">Average duration</div>
      </div>
      <div class="stat-card">
        <h3>üèÜ Top User</h3>
        <div class="number" id="top-user">-</div>
        <div class="subtext" id="top-user-msg">Most messages</div>
      </div>
    </div>

    <h3>üìä Message Distribution</h3>
    <div id="message-distribution" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin-top: 10px;">
      Loading distribution chart...
    </div>
  </div>

  <!-- Configuration Tab -->
  <div id="config-tab" class="tab-content">
    <h2>‚öôÔ∏è System Configuration</h2>
    <div class="stat-card" style="text-align: left;">
      <h3>Current Configuration</h3>
      <div id="config-display">Loading...</div>
    </div>

    <div class="controls" style="margin-top: 20px;">
      <button class="btn btn-info" onclick="loadConfig()">üîÑ Refresh Config</button>
      <button class="btn btn-danger" onclick="resetAllBots()">üîÑ Reset All Bots</button>
      <button class="btn btn-primary" onclick="openAdminPanel()">‚öôÔ∏è Open Admin Panel</button>
    </div>
  </div>

  <!-- Real-time Logs -->
  <h2>üìù System Logs</h2>
  <div class="logs" id="logs"></div>
</div>

<script>
const API_BASE = "http://localhost:8000";
let activeRooms = [];
let selectedRoomId = null;
let chatMonitorInterval = null;
let isMonitoring = false;

function log(msg) {
  const logs = document.getElementById('logs');
  const time = new Date().toLocaleTimeString();
  logs.innerHTML = `[${time}] ${msg}<br>` + logs.innerHTML;
  if(logs.children.length > 100) {
    logs.removeChild(logs.lastChild);
  }
}

function switchTab(tabName) {
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });

  // Remove active class from all buttons
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });

  // Show selected tab
  document.getElementById(`${tabName}-tab`).classList.add('active');

  // Activate corresponding button
  document.querySelector(`button[onclick="switchTab('${tabName}')"]`).classList.add('active');

  // Load data for tab if needed
  if(tabName === 'rooms') {
    refreshRooms();
  } else if(tabName === 'stats') {
    loadDetailedStats();
  } else if(tabName === 'config') {
    loadConfig();
  }

  log(`Switched to ${tabName} tab`);
}

async function refreshRooms() {
  try {
    // Fetch room information
    const res = await fetch(`${API_BASE}/api/admin/rooms`);
    if (!res.ok) throw new Error('Failed to fetch rooms');
    const data = await res.json();

    activeRooms = data.rooms || [];

    // Update statistics
    document.getElementById('total-rooms').textContent = activeRooms.length;
    document.getElementById('total-users').textContent = activeRooms.reduce((sum, room) => sum + (room.participants?.length || 0), 0);
    document.getElementById('total-messages').textContent = activeRooms.reduce((sum, room) => sum + (room.message_count || 0), 0);

    // Update bot status
    const botEnabled = data.bot_enabled || false;
    document.getElementById('bot-status').textContent = botEnabled ? '‚úÖ' : '‚ùå';
    document.getElementById('bot-status-text').textContent = botEnabled ? 'Enabled' : 'Disabled';

    // Update rooms table
    const tbody = document.getElementById('rooms-body');

    if(activeRooms.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No active rooms</td></tr>';
      log('‚úì No active rooms');
      return;
    }

    tbody.innerHTML = activeRooms.map(room => {
      const created = new Date(room.created_at).toLocaleTimeString();
      const participants = room.participants ? room.participants.join(', ') : 'None';
      const messageCount = room.message_count || 0;
      const botEnabled = room.bot_enabled ? '‚úÖ' : '‚ùå';
      const connections = room.connections || 0;

      return `
        <tr>
          <td><code>${room.id}</code></td>
          <td>${participants}</td>
          <td>${messageCount}</td>
          <td>${created}</td>
          <td>${botEnabled}</td>
          <td>${connections}</td>
          <td>
            <button class="btn btn-info btn-sm" onclick="monitorRoom('${room.id}')">üëÅÔ∏è Monitor</button>
            <button class="btn btn-danger btn-sm" onclick="endRoom('${room.id}')">‚ùå End</button>
            <button class="btn btn-primary btn-sm" onclick="joinRoom('${room.id}')">üö™ Join</button>
            <button class="btn btn-success btn-sm" onclick="exportRoomChatHistory('${room.id}')">üì• Export</button>
          </td>
        </tr>
      `;
    }).join('');

    log(`‚úì Loaded ${activeRooms.length} active rooms`);

    // Update monitor sidebar
    updateMonitorRoomList();

  } catch(e) {
    log(`‚úó Error loading rooms: ${e.message}`);
    const tbody = document.getElementById('rooms-body');
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#f66;">Error loading rooms</td></tr>';
  }
}

function updateMonitorRoomList() {
  const roomList = document.getElementById('monitor-room-list');

  if(activeRooms.length === 0) {
    roomList.innerHTML = '<div class="empty-state">No active rooms</div>';
    return;
  }

  roomList.innerHTML = activeRooms.map(room => {
    const isActive = selectedRoomId === room.id;
    const participantCount = room.participants ? room.participants.length : 0;
    const messageCount = room.message_count || 0;

    return `
      <div class="room-item ${isActive ? 'active' : ''}" onclick="selectRoomForMonitor('${room.id}')">
        <div class="room-info">
          <div>
            <strong>${room.id.substring(0, 8)}...</strong>
            <div style="font-size: 11px; opacity: 0.7;">
              ${participantCount} users ‚Ä¢ ${messageCount} msgs
            </div>
          </div>
          ${isActive ? 'üëÅÔ∏è' : ''}
        </div>
      </div>
    `;
  }).join('');
}

function selectRoomForMonitor(roomId) {
  selectedRoomId = roomId;
  updateMonitorRoomList();
  loadRoomMessages(roomId);
  log(`Selected room ${roomId} for monitoring`);

  // ÂêØÁî®ÂØºÂá∫ÊåâÈíÆ
  document.getElementById('export-csv-btn').disabled = false;
  document.getElementById('export-json-btn').disabled = false;
}

async function loadRoomMessages(roomId) {
  try {
    const res = await fetch(`${API_BASE}/api/admin/rooms/${roomId}/messages`);
    if (!res.ok) throw new Error('Failed to fetch messages');
    const data = await res.json();

    const messages = data.messages || [];
    const container = document.getElementById('chat-messages-container');
    const title = document.getElementById('selected-room-title');

    title.textContent = `üí¨ Room: ${roomId.substring(0, 12)}... (${messages.length} messages)`;

    if(messages.length === 0) {
      container.innerHTML = '<div class="empty-state">No messages in this room</div>';
      return;
    }

    container.innerHTML = messages.map(msg => {
      const time = new Date(msg.timestamp).toLocaleTimeString();
      const isBot = msg.sender.toLowerCase().includes('bot');
      const isSystem = msg.sender.toLowerCase().includes('system');
      const msgClass = isBot ? 'bot' : (isSystem ? 'system' : 'user');

      return `
        <div class="message ${msgClass}">
          <div class="message-header">
            <span class="message-sender">${msg.sender}</span>
            <span class="message-time">${time}</span>
          </div>
          <div class="message-content">${msg.text}</div>
        </div>
      `;
    }).join('');

    // Scroll to bottom
    container.scrollTop = container.scrollHeight;

  } catch(e) {
    log(`‚úó Error loading messages: ${e.message}`);
    document.getElementById('chat-messages-container').innerHTML =
      '<div class="empty-state">Error loading messages</div>';
  }
}

function startChatMonitor() {
  if(isMonitoring) {
    log('‚ö†Ô∏è Monitoring already active');
    return;
  }

  isMonitoring = true;
  chatMonitorInterval = setInterval(() => {
    if(selectedRoomId) {
      loadRoomMessages(selectedRoomId);
    }
    refreshRooms();
  }, 2000);

  log('‚úÖ Started chat monitoring (2s intervals)');
}

function stopChatMonitor() {
  if(!isMonitoring) {
    log('‚ö†Ô∏è Monitoring not active');
    return;
  }

  isMonitoring = false;
  clearInterval(chatMonitorInterval);
  log('‚èπÔ∏è Stopped chat monitoring');
}

function clearChatDisplay() {
  document.getElementById('chat-messages-container').innerHTML =
    '<div class="empty-state">Display cleared</div>';
  document.getElementById('selected-room-title').textContent = 'üí¨ Chat Messages';
  log('üóëÔ∏è Cleared chat display');
}

function monitorRoom(roomId) {
  switchTab('chat');
  setTimeout(() => {
    selectRoomForMonitor(roomId);
  }, 100);
}

function endRoom(roomId) {
  if(confirm(`Are you sure you want to end room ${roomId}?`)) {
    fetch(`${API_BASE}/api/admin/rooms/${roomId}/end`, { method: 'POST' })
      .then(() => {
        log(`‚úÖ Ended room ${roomId}`);
        refreshRooms();
      })
      .catch(err => {
        log(`‚úó Error ending room: ${err.message}`);
      });
  }
}

function joinRoom(roomId) {
  const userId = `admin_${Math.random().toString(36).substr(2, 6)}`;
  const url = `/chat?uid=${encodeURIComponent(userId)}&room=${encodeURIComponent(roomId)}`;
  window.open(url, '_blank');
  log(`üö™ Joined room ${roomId} as ${userId}`);
}

// ÂØºÂá∫ËÅäÂ§©ÂéÜÂè≤ÂäüËÉΩ
async function exportChatHistory(format = 'csv') {
  if (!selectedRoomId) {
    alert("Please select a room first!");
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/api/admin/rooms/${selectedRoomId}/export?format=${format}`);
    if (!res.ok) throw new Error('Failed to export chat history');

    const data = await res.json();

    if (data.status === "success") {
      if (format === 'csv') {
        // ‰∏ãËΩΩCSVÊñá‰ª∂
        const blob = new Blob([data.content], {type: 'text/csv;charset=utf-8;'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = data.filename || `chat_history_${selectedRoomId}.csv`;
        link.click();
        log(`üì• Exported CSV chat history for room ${selectedRoomId}`);
      } else if (format === 'json') {
        // ‰∏ãËΩΩJSONÊñá‰ª∂
        const jsonStr = JSON.stringify(data.data, null, 2);
        const blob = new Blob([jsonStr], {type: 'application/json;charset=utf-8;'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = data.filename || `chat_history_${selectedRoomId}.json`;
        link.click();
        log(`üì• Exported JSON chat history for room ${selectedRoomId}`);
      }
    } else {
      alert(`Export failed: ${data.message}`);
      log(`‚úó Export failed: ${data.message}`);
    }
  } catch (error) {
    alert(`Export error: ${error.message}`);
    log(`‚úó Export error: ${error.message}`);
  }
}

// ‰ªéÊàøÈó¥Ë°®Ê†º‰∏≠ÂØºÂá∫Âçï‰∏™ÊàøÈó¥ÁöÑËÅäÂ§©ÂéÜÂè≤
async function exportRoomChatHistory(roomId) {
  try {
    const res = await fetch(`${API_BASE}/api/admin/rooms/${roomId}/export?format=csv`);
    if (!res.ok) throw new Error('Failed to export chat history');

    const data = await res.json();

    if (data.status === "success") {
      const blob = new Blob([data.content], {type: 'text/csv;charset=utf-8;'});
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = data.filename || `chat_history_${roomId}.csv`;
      link.click();
      log(`üì• Exported chat history for room ${roomId}`);
    } else {
      alert(`Export failed: ${data.message}`);
      log(`‚úó Export failed for room ${roomId}: ${data.message}`);
    }
  } catch (error) {
    alert(`Export error: ${error.message}`);
    log(`‚úó Export error for room ${roomId}: ${error.message}`);
  }
}

// ÊâπÈáèÂØºÂá∫ÊâÄÊúâÊàøÈó¥ÁöÑËÅäÂ§©ÂéÜÂè≤
async function exportAllChatHistories() {
  if (activeRooms.length === 0) {
    alert("No active rooms to export!");
    return;
  }

  if (!confirm(`Export chat history for all ${activeRooms.length} rooms? This may take a while.`)) {
    return;
  }

  const exportPromises = activeRooms.map(async (room) => {
    try {
      const res = await fetch(`${API_BASE}/api/admin/rooms/${room.id}/export?format=csv`);
      if (res.ok) {
        const data = await res.json();
        if (data.status === "success") {
          return {
            roomId: room.id,
            success: true,
            content: data.content,
            filename: data.filename,
            messageCount: room.message_count || 0
          };
        }
      }
      return {
        roomId: room.id,
        success: false,
        error: "Export failed"
      };
    } catch (error) {
      return {
        roomId: room.id,
        success: false,
        error: error.message
      };
    }
  });

  try {
    log(`‚è≥ Starting export for ${activeRooms.length} rooms...`);
    const results = await Promise.all(exportPromises);

    const successful = results.filter(r => r.success);
    const failed = results.filter(r => !r.success);

    if (successful.length > 0) {
      // ÂàõÂª∫‰∏Ä‰∏™ZIPÊñá‰ª∂ÂåÖÂê´ÊâÄÊúâÂØºÂá∫ÁöÑCSV
      await createZipFile(successful);
      log(`‚úÖ Successfully exported ${successful.length} rooms, ${failed.length} failed`);
    } else {
      alert("No rooms exported successfully!");
      log(`‚úó All exports failed`);
    }

  } catch (error) {
    alert(`Export error: ${error.message}`);
    log(`‚úó Export error: ${error.message}`);
  }
}

// ÂàõÂª∫ZIPÊñá‰ª∂
async function createZipFile(successfulExports) {
  // È¶ñÂÖàÊ£ÄÊü•ÊòØÂê¶Â∑≤Âä†ËΩΩJSZip
  if (typeof JSZip === 'undefined') {
    alert("JSZip library not loaded. Exporting individual files instead.");

    // Â¶ÇÊûúÊ≤°ÊúâJSZipÔºåÂçïÁã¨‰∏ãËΩΩÊØè‰∏™Êñá‰ª∂
    successfulExports.forEach(exportData => {
      const blob = new Blob([exportData.content], {type: 'text/csv;charset=utf-8;'});
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = exportData.filename;
      link.click();
    });
    return;
  }

  const zip = new JSZip();

  // Ê∑ªÂä†ÊØè‰∏™ÊàøÈó¥ÁöÑCSVÊñá‰ª∂Âà∞ZIP
  successfulExports.forEach(exportData => {
    zip.file(exportData.filename, exportData.content);
  });

  // Ê∑ªÂä†Ê±áÊÄª‰ø°ÊÅØ
  const timestamp = new Date().toISOString();
  const totalMessages = successfulExports.reduce((sum, exp) => sum + exp.messageCount, 0);

  const summaryContent = `Chat History Export Summary

Export Date: ${timestamp}
Total Rooms: ${successfulExports.length}
Total Messages: ${totalMessages}

Room Details:
${successfulExports.map(exp => `- ${exp.roomId}: ${exp.messageCount} messages`).join('\n')}
`;

  zip.file("EXPORT_SUMMARY.txt", summaryContent);

  // ÁîüÊàêÂπ∂‰∏ãËΩΩZIPÊñá‰ª∂
  const content = await zip.generateAsync({type: "blob"});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(content);
  link.download = `chat_histories_${new Date().getTime()}.zip`;
  link.click();
}

async function loadDetailedStats() {
  try {
    const res = await fetch(`${API_BASE}/api/admin/stats`);
    const stats = await res.json();

    document.getElementById('today-messages').textContent = stats.today_messages || 0;
    document.getElementById('active-now').textContent = stats.active_now || 0;
    document.getElementById('avg-session').textContent = `${stats.avg_session || 0}m`;
    document.getElementById('top-user').textContent = stats.top_user || '-';
    document.getElementById('top-user-msg').textContent = `${stats.top_user_messages || 0} messages`;

    // Update distribution
    const distribution = document.getElementById('message-distribution');
    if(stats.distribution) {
      distribution.innerHTML = Object.entries(stats.distribution)
        .map(([user, count]) => `
          <div style="margin: 5px 0; display: flex; align-items: center;">
            <div style="width: 100px;">${user}</div>
            <div style="flex: 1; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
              <div style="background: #4CAF50; height: 20px; width: ${(count/stats.total_messages*100)}%;"></div>
            </div>
            <div style="width: 50px; text-align: right;">${count}</div>
          </div>
        `).join('');
    }

  } catch(e) {
    log(`‚úó Error loading stats: ${e.message}`);
  }
}

async function loadConfig() {
  try {
    const res = await fetch(`${API_BASE}/api/admin/config`);
    const config = await res.json();

    document.getElementById('config-display').innerHTML = `
      <pre style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; overflow: auto;">
Group Size: ${config.group_size}
Chat Duration: ${config.duration} minutes
Bot Enabled: ${config.bot_enabled ? '‚úÖ' : '‚ùå'}
Bot Name: ${config.bot_name}
Bot Delay: ${config.bot_delay} seconds
Bot Prompt: ${config.bot_prompt ? config.bot_prompt.substring(0, 100) + '...' : 'Default'}
      </pre>
    `;

  } catch(e) {
    log(`‚úó Error loading config: ${e.message}`);
  }
}

function resetAllBots() {
  if(confirm('Are you sure you want to reset all bot instances?')) {
    fetch(`${API_BASE}/api/admin/bots/reset`, { method: 'POST' })
      .then(() => {
        log('‚úÖ Reset all bot instances');
      })
      .catch(err => {
        log(`‚úó Error resetting bots: ${err.message}`);
      });
  }
}

function openAdminPanel() {
  window.open('/admin', '_blank');
  log('‚öôÔ∏è Opened admin panel');
}

function filterRooms() {
  const searchTerm = document.getElementById('room-search').value.toLowerCase();
  const rows = document.querySelectorAll('#rooms-body tr');

  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(searchTerm) ? '' : 'none';
  });
}

function exportRoomsCSV() {
  let csv = 'Room ID,Participants,Message Count,Created At,Bot Enabled,Connections\n';

  activeRooms.forEach(room => {
    const participants = room.participants ? room.participants.join(';') : '';
    const created = new Date(room.created_at).toISOString();
    const botEnabled = room.bot_enabled ? 'Yes' : 'No';

    csv += `"${room.id}","${participants}",${room.message_count || 0},"${created}",${botEnabled},${room.connections || 0}\n`;
  });

  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `rooms_${new Date().getTime()}.csv`;
  link.click();
  log(`üì• Exported ${activeRooms.length} rooms to CSV`);
}

function cleanupInactiveRooms() {
  if(confirm('Clean up inactive rooms (older than 1 hour)?')) {
    fetch(`${API_BASE}/api/admin/rooms/cleanup`, { method: 'POST' })
      .then(() => {
        log('üßπ Cleaned up inactive rooms');
        refreshRooms();
      })
      .catch(err => {
        log(`‚úó Error cleaning rooms: ${err.message}`);
      });
  }
}

// Initialize
refreshRooms();
setInterval(refreshRooms, 5000); // Refresh every 5 seconds

// Auto-switch to monitoring if room is selected
setInterval(() => {
  if(selectedRoomId && isMonitoring) {
    loadRoomMessages(selectedRoomId);
  }
}, 1000);

log('‚úÖ Chat Monitoring Dashboard initialized');
</script>

</body>
</html>